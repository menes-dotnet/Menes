trigger:
  branches:
    include:
    - master
    - feature/*
  tags:
    include:
    - '*'

resources:
  repositories:
    - repository: recommended_practices
      type: github
      name: endjin/Endjin.RecommendedPractices.AzureDevopsPipelines.GitHub
      endpoint: menes-dotnet-github
      ref: refs/heads/feature/release-hooks

jobs:
- template: templates/build.and.release.yml@recommended_practices
  parameters:
    vmImage: 'ubuntu-latest'
    service_connection_nuget_org: $(Endjin_Service_Connection_NuGet_Org)
    service_connection_github: $(Endjin_Service_Connection_GitHub)
    solution_to_build: $(Endjin_Solution_To_Build)
    netSdkVersion: '3.x'
    postPublishNugetPackages:
      - pwsh: |
          $body = @{
            username = "endjin-bot"
            icon_emoji = ":mike:"
          }

          $messageLines = @("The following packages have been published to nuget.org:")

          Write-Host "Build_ArtifactStagingDirectory: $($env:Build_ArtifactStagingDirectory)"
          $packages = gci -Recurse -Filter *.nupkg -Path "$($env:Build_ArtifactStagingDirectory)/Release/NuGet/Packages"
          Write-Host $packages
          foreach ($p in $packages) {
              $packageName = [IO.Path]::GetFileNameWithoutExtension($p.Name) -replace ".$($env:GitVersion_SemVer)",""
              $messageLines += "- <https://nuget.org/packages/$packageName/$($env:GitVersion_SemVer)|$packageName>"
          }
          $messageLines += "`nThe GitHub release is here: https://github.com/$($env:Endjin_Repository_Name)/releases/tag/$($env:GitVersion_SemVer)"

          $body += @{ text = ($messageLines -join "`n") }
          Write-Host "body:`n$(ConvertTo-Json $body)"
          Invoke-RestMethod -uri "$($env:Endjin_Slack_ReleasesWebhookUri)" `
                            -Method Post `
                            -body (ConvertTo-Json $body) `
                            -ContentType 'application/json'
        displayName: Send notification to Slack channel
        env:
          Endjin_Slack_ReleasesWebhookUri: $(Endjin_Slack_ReleasesWebhookUri)
          Endjin_Repository_Name: $(Endjin_Repository_Name)
          GitVersion_SemVer: $(GitVersion.SemVer)
          Build_ArtifactStagingDirectory: $(Build.ArtifactStagingDirectory)
          
        #condition: and(succeeded(), or(variables['Endjin.ForcePublish'], eq(variables['GitVersion.PreReleaseTag'], '')))